<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artistic Tools Hub - Admin</title>
    <!-- Load Auth0 SDK version 1.22.5 -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/1.22.5/auth0-spa-js.production.js"></script>
    <!-- Prevent Netlify CMS auto-initialization -->
    <script>window.CMS_MANUAL_INIT = true;</script>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
</head>

<body>
    <div id="app">
        <h1>Admin Dashboard</h1>
        <button id="login-btn" style="display: none;">Log In</button>
        <button id="logout-btn" style="display: none;">Log Out</button>
        <div id="cms-content" style="display: none;">
            <!-- CMS will load here -->
        </div>
    </div>
    <script>
        let auth0Client;

        async function initAuth0() {
            try {
                auth0Client = await window.createAuth0Client({
                    domain: 'dev-d07c5upcmrg0jedl.us.auth0.com',
                    client_id: 'mbJ5rUjoVg7ztjnzO7MsHKlv66KYlkF1',  // Use client_id for version 1.22.5
                    redirect_uri: window.location.origin + '/admin'  // Moved out of authorizationParams
                });
                console.log('Auth0 initialized');

                const isAuthenticated = await auth0Client.isAuthenticated();
                if (isAuthenticated) {
                    document.getElementById('logout-btn').style.display = 'block';
                    document.getElementById('cms-content').style.display = 'block';
                    loadCMS();
                } else {
                    const loginBtn = document.getElementById('login-btn');
                    loginBtn.style.display = 'block';
                    loginBtn.addEventListener('click', async () => {
                        await auth0Client.loginWithRedirect();
                    });
                }

                if (window.location.search.includes('code=')) {
                    await auth0Client.handleRedirectCallback();
                    window.history.replaceState({}, document.title, '/admin');
                    document.getElementById('login-btn').style.display = 'none';
                    document.getElementById('logout-btn').style.display = 'block';
                    document.getElementById('cms-content').style.display = 'block';
                    loadCMS();
                }
            } catch (err) {
                console.error('Auth0 init error:', err);
                document.getElementById('app').innerHTML += '<p>Error loading authentication: ' + err.message + '</p>';
            }
        }

        function loadCMS() {
            try {
                window.CMS.init({
                    configUrl: '/admin/config.yml'  // Ensure CMS loads the correct config file
                });
                console.log('CMS initialized');
            } catch (err) {
                console.error('CMS init error:', err);
                document.getElementById('cms-content').innerHTML = '<p>Error loading CMS: ' + err.message + '</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initAuth0();
        });
    </script>
</body>

</html>