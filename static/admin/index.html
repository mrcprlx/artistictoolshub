<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artistic Tools Hub - Admin</title>
</head>

<body>
    <div id="app">
        <h1>Admin Dashboard</h1>
        <button id="login-btn" style="display: none;">Log In</button>
        <button id="logout-btn" style="display: none;">Log Out</button>
        <div id="cms-content" style="display: none;">
            <!-- CMS will load here -->
        </div>
    </div>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    <script>
        console.log('Starting script execution');

        // Function to dynamically load a script and confirm itâ€™s ready
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.onload = () => {
                    console.log('Script loaded successfully:', src);
                    resolve();
                };
                script.onerror = () => {
                    console.error('Failed to load script:', src);
                    reject(new Error(`Failed to load script: ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // Initialize Auth0
        async function initAuth0() {
            try {
                console.log('Attempting to load Auth0 SDK');
                await loadScript('https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js');

                // Verify Auth0 is available
                if (!window.auth0 || !window.auth0.createAuth0Client) {
                    throw new Error('Auth0 SDK not loaded or incomplete');
                }
                console.log('Auth0 SDK confirmed loaded');

                const auth0Client = await window.auth0.createAuth0Client({
                    domain: 'dev-d07c5upcmrg0jedl.us.auth0.com',
                    clientId: 'mbJ5rUjoVg7ztjnzO7MsHKlv66KYlkF1',
                    authorizationParams: {
                        redirect_uri: window.location.origin + '/admin'
                    }
                });
                console.log('Auth0 client initialized');

                const isAuthenticated = await auth0Client.isAuthenticated();
                if (isAuthenticated) {
                    document.getElementById('logout-btn').style.display = 'block';
                    document.getElementById('cms-content').style.display = 'block';
                    loadCMS();
                } else {
                    document.getElementById('login-btn').style.display = 'block';
                }

                if (window.location.search.includes('code=')) {
                    await auth0Client.handleRedirectCallback();
                    window.history.replaceState({}, document.title, '/admin');
                    document.getElementById('login-btn').style.display = 'none';
                    document.getElementById('logout-btn').style.display = 'block';
                    document.getElementById('cms-content').style.display = 'block';
                    loadCMS();
                }
            } catch (err) {
                console.error('Auth0 initialization failed:', err.message);
                document.getElementById('app').innerHTML += '<p>Error loading authentication: ' + err.message + '</p>';
            }
        }

        // Initialize CMS with inline config
        function loadCMS() {
            try {
                const config = {
                    backend: {
                        name: 'git-gateway',
                        branch: 'main'
                    },
                    media_folder: 'static/uploads',
                    public_folder: '/uploads',
                    collections: [{
                        name: 'creations',
                        label: 'Creations',
                        folder: 'content/creations',
                        create: true,
                        slug: '{{slug}}',
                        fields: [
                            { label: 'Text', name: 'text', widget: 'text', required: true },
                            { label: 'Image', name: 'image', widget: 'image', required: false },
                            { label: 'Author', name: 'author', widget: 'string', required: false }
                        ]
                    }]
                };
                console.log('Initializing CMS with inline config:', config);

                // Ensure CMS is available and initialize with config
                if (typeof CMS === 'undefined') {
                    throw new Error('Netlify CMS not loaded');
                }
                CMS.init({ config: config });
                console.log('CMS initialized successfully');
            } catch (err) {
                console.error('CMS initialization failed:', err.message);
                document.getElementById('cms-content').innerHTML = '<p>Error loading CMS: ' + err.message + '</p>';
            }
        }

        // Event listeners for login/logout
        document.getElementById('login-btn').addEventListener('click', async () => {
            try {
                await auth0Client.loginWithRedirect();
            } catch (err) {
                console.error('Login failed:', err);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await auth0Client.logout({ logoutParams: { returnTo: window.location.origin } });
            } catch (err) {
                console.error('Logout failed:', err);
            }
        });

        // Start the initialization
        initAuth0();
    </script>
</body>

</html>