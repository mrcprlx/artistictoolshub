<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artistic Tools Hub - Admin</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body>
    <script>
        // Initialize Netlify Identity first
        netlifyIdentity.init();
        console.log('Netlify Identity initialized');

        // Check for invite token in hash
        if (window.location.hash.includes('invite_token')) {
            console.log('Invite token found:', window.location.hash);
            netlifyIdentity.open('signup'); // Widget should handle token from hash
        } else {
            console.log('No invite token, showing login');
            netlifyIdentity.open('login');
        }

        // Load CMS only after login/signup
        netlifyIdentity.on('login', () => {
            console.log('User logged in, loading CMS and redirecting to /reviewadmin');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js';
            script.onload = () => {
                CMS.init({
                    config: {
                        backend: { name: 'git-gateway', branch: 'main' },
                        media_folder: 'static/uploads',
                        public_folder: '/uploads',
                        collections: [{
                            name: 'creations',
                            label: 'Creations',
                            folder: 'content/creations',
                            create: true,
                            slug: '{{slug}}',
                            fields: [
                                { label: 'Text', name: 'text', widget: 'text', required: true },
                                { label: 'Image', name: 'image', widget: 'image', required: false },
                                { label: 'Author', name: 'author', widget: 'string', required: false }
                            ]
                        }]
                    }
                });
                window.location.href = '/reviewadmin';
            };
            document.body.appendChild(script);
        });
    </script>
</body>

</html>